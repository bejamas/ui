---
/**
 * @component Select
 * @title Select
 * @description Accessible select with custom styling and indicator.
 * @status stable
 * @since 0.1.0
 *
 * @example
 *
 * <div class="flex flex-col gap-2">
 *   <Label for="fruits">Select a fruit</Label>
 *   <Select id="fruits" class="w-[180px]">
 *     <option value="apple">Apple</option>
 *     <option value="banana">Banana</option>
 *     <option value="cherry">Cherry</option>
 *   </Select>
 * </div>
 */

import { ChevronDown } from "@lucide/astro";
import type { HTMLAttributes } from "astro/types";
import { cva } from "class-variance-authority";
import { cn } from "@bejamas/ui/lib/utils";

interface Props extends HTMLAttributes<"select"> {
  variant?: "default" | "ghost" | "neutral";
  showCheckmark?: boolean;
  options?: Array<
    string | { value: string; label?: string; disabled?: boolean }
  >;
}

const {
  id = "",
  variant = "default",
  class: className = "",
  showCheckmark = true,
  options = [],
  ...rest
} = Astro.props as Props;

const baseClasses =
  "block w-full select appearance-none relative shadow-xs rounded-md bg-background ps-4 pe-10 py-2 text-sm text-foreground transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:border-ring disabled:cursor-not-allowed disabled:opacity-50 [&_option]:rounded-md [&_option]:p-2";

const optionBaseClasses =
  "px-3 py-1.5 text-foreground hover:bg-foreground/10 active:bg-neutral active:text-neutral-content disabled:text-foreground/40";

const selectVariants = cva(baseClasses, {
  variants: {
    variant: {
      default: "border border-border",
      ghost: "border-0 bg-transparent shadow-none focus:bg-background",
      neutral:
        "border border-neutral/50 focus:border-neutral focus:ring-neutral",
    },
  },
  defaultVariants: {
    variant: "default",
  },
});

const selectClasses = cn(
  selectVariants({ variant }),
  !showCheckmark && "hide-checkmark",
);

const controlId =
  id ||
  (rest as Record<string, any>).name ||
  `select-${Math.random().toString(36).slice(2, 9)}`;

const selectedValue = (rest as Record<string, any>).value ?? "";
---

<div class={cn("relative")}>
  <select
    id={controlId}
    class={cn("select", selectClasses, className)}
    {...rest}
  >
    {
      options.length ? (
        options.map((opt) => {
          const isObject = typeof opt === "object";
          const optionValue = isObject ? opt.value : opt;
          const optionLabel = isObject ? (opt.label ?? opt.value) : opt;

          return (
            <option
              value={optionValue}
              selected={selectedValue === optionValue}
            >
              {optionLabel}
            </option>
          );
        })
      ) : (
        <slot />
      )
    }
  </select>
  <ChevronDown
    slot="indicator"
    class="size-4 text-foreground/60 absolute right-3 top-1/2 -translate-y-1/2"
  />
  <!-- <svg
      aria-hidden="true"
      class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-foreground/60"
      viewBox="0 0 20 20"
      fill="currentColor"
    >
      <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd" />
    </svg> -->
</div>

<style>
  @reference "tailwindcss";
  @reference "../styles/globals.css";

  .hide-checkmark {
    option::checkmark {
      @apply hidden;
    }
  }

  :where(.select) {
    &::picker(select) {
      @supports (appearance: base-select) {
        appearance: base-select;
      }
      border-color: var(--border);
      @apply rounded-lg my-2 p-1 shadow-lg bg-popover text-popover-foreground;
    }
    &::picker-icon {
      @apply hidden;
    }
    :where(optgroup) :where(option) {
      &:nth-child(1) {
        @apply mt-[0.5em];
      }
    }

    :where(option) {
      @apply transition-colors duration-200 ease-in-out;

      &:not(:disabled) {
        &:hover,
        &:focus-visible {
          @apply cursor-pointer outline-hidden;
        }
        &:active {
          box-shadow: 0 2px calc(var(--depth) * 3px) -2px var(--foreground);
        }
      }
    }
  }

  @supports (appearance: base-select) {
    select {
      appearance: base-select;
    }
  }
</style>
