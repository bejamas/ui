---
import Separator from "@bejamas/ui/components/Separator.astro";
import { defaultPresets } from "../utils/themes/presets";

const tabs = [
  {
    label: "fintech",
    icon: "globe",
    theme: "berlin",
    preview: "/fintech",
    color: "#e2ebff",
  },
  // {
  //   label: "ai",
  //   icon: "heart",
  //   theme: "tokyo",
  //   preview: "/ai",
  //   color: "#f1c4e6",
  // },
  {
    label: "health",
    icon: "heart",
    theme: "rome",
    preview: "/health",
    color: "#EBA91C",
  },
];

const componentsShowreel = {
  label: "components showreel",
  icon: "globe",
  theme: "default",
  preview: "/ui-demo",
  color: "hsl(203.9433 167.9983% 39.1847%)",
};

// Lean presets payload for the client (label + styles only)
const leanPresets = Object.fromEntries(
  Object.entries(defaultPresets).map(([key, p]) => [
    key,
    {
      label: p.label ?? key,
      styles: { light: p.styles?.light ?? {}, dark: p.styles?.dark ?? {} },
    },
  ]),
);
---

<script>
  import { applyThemeToCss } from "../utils/themes/apply-theme.ts";
  // expose CSS generator for client usage
  window.bejamas = window.bejamas || {};
  window.bejamas.applyThemeCss = applyThemeToCss;
</script>
<script src="https://unpkg.com/alpinejs@3.x.x" defer></script>
<script type="module" define:vars={{ leanPresets, componentsShowreel }}>
  window.BEJAMAS_PRESETS = leanPresets;
  window.__getCurrentMode = () => {
    if (window.astroThemeToggle?.getTheme)
      return window.astroThemeToggle.getTheme();
    const el = document.documentElement;
    const attr = el.getAttribute("data-theme");
    if (attr === "dark" || attr === "light") return attr;
    return el.classList.contains("dark") ? "dark" : "light";
  };
  window.applyPresetByKey = (key) => {
    const preset = window.BEJAMAS_PRESETS?.[key];
    if (!preset || !window.bejamas?.applyThemeCss) return;

    // save to cookie
    document.cookie = `theme=${key}; path=/;`;
    try {
      localStorage.setItem("theme-preset", key);
    } catch (e) {}

    const cssText = window.bejamas.applyThemeCss({
      ...preset,
      currentMode: window.__getCurrentMode(),
    });
    const id = "hero-theme-css";
    let styleEl = document.getElementById(id);
    if (!styleEl) {
      styleEl = document.createElement("style");
      styleEl.id = id;
      document.head.appendChild(styleEl);
    }
    styleEl.textContent = cssText;
  };
</script>
<div
  x-data="{
    activeIndex: 0,
    iframeActive: false,
    observer: null,
    themeIndexMap: {},
    getPersistedThemeKey() {
      const stored = localStorage.getItem('theme-preset');
      if (stored) return stored;
      const match = document.cookie.match(/(?:^|;)\s*theme=([^;]+)/);
      return match ? decodeURIComponent(match[1]) : null;
    },
    setActiveByThemeKey(key) {
      if (!key) return;
      const idx = this.themeIndexMap?.[key];
      if (typeof idx === 'number') this.setActive(idx, key);
    },
    init() {
      this.themeIndexMap = {};
      this.$root.querySelectorAll('[data-key][data-index]').forEach((btn) => {
        if (btn.dataset.key && btn.dataset.index !== undefined) {
          this.themeIndexMap[btn.dataset.key] = Number(btn.dataset.index);
        }
      });

      const persistedKey = this.getPersistedThemeKey();
      if (persistedKey && this.themeIndexMap[persistedKey] !== undefined) {
        this.setActive(this.themeIndexMap[persistedKey], persistedKey);
      } else {
        const first = this.$root.querySelector('[data-key]');
        if (first?.dataset.key && typeof window.applyPresetByKey === 'function') {
          window.applyPresetByKey(first.dataset.key);
        }
      }

      window.addEventListener('storage', (event) => {
        if (event.key === 'theme-preset' && event.newValue) {
          this.setActiveByThemeKey(event.newValue);
        }
      });

      const panel = this.$refs.panel || this.$root;
      const onIntersect = (entries) => {
        console.log(entries);
        for (const entry of entries) {
          this.iframeActive = entry.isIntersecting && entry.intersectionRatio >= 0.9;
        }
      };
      this.observer = new IntersectionObserver(onIntersect, { threshold: [0, 0.5, 0.9, 1] });
      this.observer.observe(panel);
    },
    setActive(i, key) {
      this.activeIndex = Number(i);
      if (typeof window.applyPresetByKey === 'function') window.applyPresetByKey(key);
    },
    activateIframe() {
    console.log('activateIframe');
    console.log(this.activeIndex);
      const panel = this.$refs.panel || this.$root;
      const panelEnd = document.getElementById('browser-hero-panel-end');
      panelEnd.scrollIntoView({ behavior: 'smooth', block: 'end', inline: 'nearest' });
      this.iframeActive = true;
    },
  }"
  class="browser will-change-transform mt-0 not-content relative z-10 h-[calc(100svh_-_var(--spacing)_*_18)] rounded-t-lg lg:rounded-t-2xl overflow-clip flex flex-col"
>
  <div
    class="bg-input/40 dark:bg-input/30 backdrop-blur-xl not-content px-5 lg:pt-2 flex"
  >
    <div class="hidden lg:flex items-center gap-x-2 mb-1.75">
      <div class="size-3 bg-muted-foreground/20 rounded-full"></div>
      <div class="size-3 bg-muted-foreground/20 rounded-full"></div>
      <div class="size-3 bg-muted-foreground/20 rounded-full"></div>
    </div>
    <div class="md:ml-18 hidden lg:flex items-center">
      <button
        type="button"
        data-key={componentsShowreel.theme}
        data-index={0}
        data-preview={componentsShowreel.preview}
        class="rounded-t-lg text-sm min-w-32 px-3 py-3 flex items-center cursor-pointer select-none transition-colors"
        x-on:click="setActive(0, 'default')"
        x-bind:class="{
          'bg-background shadow-xs text-foreground': activeIndex === 0,
          'bg-background/50 text-foreground hover:bg-background': activeIndex !== 0
        }"
      >
        <div
          class="size-5 mr-2 rounded-sm bg-foreground"
          style={`background-color: ${componentsShowreel.color};`}
        >
        </div>
        <span class="hidden lg:block">bejamas/ui components</span>
        <span class="block lg:hidden">components</span>
      </button>
      <div class="hidden lg:flex items-center justify-center gap-x-1 ml-1">
        {
          tabs.map((tab, i) => (
            <button
              type="button"
              data-key={tab.theme}
              data-index={i + 1}
              data-preview={tab.preview}
              x-on:click="setActive($event.currentTarget.dataset.index, $event.currentTarget.dataset.key)"
              x-bind:class="{
                'bg-background shadow-xs text-foreground': activeIndex === Number($el.dataset.index),
                'bg-background/50 text-foreground hover:bg-background': activeIndex !== Number($el.dataset.index)
              }"
              class="rounded-t-lg text-sm min-w-32 px-3 py-3 flex items-center cursor-pointer select-none transition-colors"
            >
              <div
                class="size-5 mr-2 rounded-sm"
                style={`background-color: ${tab.color};`}
              />
              {tab.label}
            </button>
          ))
        }
      </div>
    </div>
  </div>
  <div class="flex-1 relative" x-ref="panel">
    <button
      type="button"
      x-show="!iframeActive"
      class="absolute inset-0 z-10 cursor-zoom-in"
      x-on:click.prevent.stop="activateIframe"
      aria-label="Activate preview"></button>
    <iframe
      src={componentsShowreel.preview}
      x-show={`activeIndex === 0`}
      x-bind:aria-hidden={`activeIndex !== 0`}
      class="w-full h-full"
      loading="lazy"></iframe>
    {
      tabs.map((tab, i) => (
        <iframe
          src={tab.preview}
          x-show={`activeIndex === ${i + 1}`}
          x-bind:aria-hidden={`activeIndex !== ${i + 1}`}
          class="w-full h-full"
          loading="lazy"
        />
      ))
    }
  </div>
</div>

<style>
  .browser {
    scroll-snap-align: center;
    box-shadow:
      0px 0px 0px 1.18145px rgba(5, 23, 41, 0.08),
      0px 1.18145px 1.18145px rgba(5, 23, 41, 0.03),
      0px 2.36289px 2.36289px rgba(5, 23, 41, 0.04),
      0px 4.72579px 4.72579px rgba(5, 23, 41, 0.05),
      0px 9.45157px 28.3547px rgba(5, 23, 41, 0.07),
      0px 1.18145px 0px rgba(5, 23, 41, 0.08);
  }
</style>
