---
import Select from "@bejamas/ui/components/Select.astro";
import { SunIcon, MoonIcon, LaptopIcon } from "@lucide/astro";
---

<div class="relative text-sm">
  <div class="absolute z-10 left-3 top-2.5">
    <SunIcon class="size-4 dark:hidden" />
    <MoonIcon class="size-4 hidden dark:block" />
  </div>
  <Select showCheckmark={false}>
    <Select part="indicator" />
    <Select
      onchange="window.toggleTheme(this.value)"
      id="theme-select"
      part="control"
      showCheckmark={false}
      class="pl-9 w-28"
    >
      <Select part="option" value="light"
        ><SunIcon class="size-4" /> Light</Select
      >
      <Select part="option" value="dark"
        ><MoonIcon class="size-4" /> Dark</Select
      >
      <Select part="option" value="auto"
        ><LaptopIcon class="size-4" /> Auto</Select
      >
    </Select>
  </Select>
</div>

<script is:inline>
  // @ts-nocheck
  const storageKey = "starlight-theme";
  const themeMetaSelector = 'meta[name="theme-color"][data-theme-managed]';
  const themeColors = {
    light: "#ffffff",
    dark: "#0f171f",
  };

  const parseTheme = (theme) =>
    theme === "auto" || theme === "dark" || theme === "light" ? theme : "auto";

  const loadTheme = () => {
    try {
      if (typeof localStorage !== "undefined") {
        return parseTheme(localStorage.getItem(storageKey));
      }
    } catch {}
    return "auto";
  };

  function storeTheme(theme) {
    try {
      if (typeof localStorage !== "undefined") {
        localStorage.setItem(
          storageKey,
          theme === "light" || theme === "dark" ? theme : "",
        );
      }
    } catch {}
  }

  function syncThemeColor(theme) {
    const color = themeColors[theme];
    const head = document.head;
    if (!color || !head) return;

    let meta = head.querySelector(themeMetaSelector);
    if (!(meta instanceof HTMLMetaElement)) {
      meta = document.createElement("meta");
      meta.setAttribute("name", "theme-color");
      meta.setAttribute("data-theme-managed", "");
      head.appendChild(meta);
    }

    meta.setAttribute("content", color);
  }

  const getPreferredColorScheme = () =>
    matchMedia("(prefers-color-scheme: light)").matches ? "light" : "dark";

  function applyTheme(theme) {
    const effective = theme === "auto" ? getPreferredColorScheme() : theme;
    document.documentElement.dataset.theme = effective;
    document.documentElement.classList.remove("light", "dark");
    document.documentElement.classList.add(effective);
    syncThemeColor(effective);
    storeTheme(theme);
    const select = document.getElementById("theme-select");
    if (select instanceof HTMLSelectElement) select.value = theme;
  }

  // Initialize
  applyTheme(loadTheme());

  // UI: select changes
  const select = document.getElementById("theme-select");
  if (select instanceof HTMLSelectElement) {
    select.addEventListener("change", (e) => {
      if (e.currentTarget instanceof HTMLSelectElement) {
        applyTheme(parseTheme(e.currentTarget.value));
      }
    });
  }

  window.toggleTheme = (theme) => applyTheme(parseTheme(theme));

  // React to system scheme changes while in 'auto'
  matchMedia("(prefers-color-scheme: light)").addEventListener("change", () => {
    if (loadTheme() === "auto") applyTheme("auto");
  });
</script>
