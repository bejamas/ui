---
import {
  Tabs,
  TabsList,
  TabsTrigger,
} from "@bejamas/ui/components/tabs";
import { Skeleton } from "@bejamas/ui/components/skeleton";
import { Button } from "@bejamas/ui/components/button";

import { SunIcon, MoonIcon, LaptopIcon, GithubIcon } from "@lucide/astro";
import PresetSwitcher from "./PresetSwitcher.astro";
import ThemeEditorGlobal from "./theme-editor/ThemeEditorGlobal.astro";
import GitHubLink from "./GitHubLink.astro";

const githubUrl = "https://github.com/bejamas/ui";
---

<div class="flex items-center gap-2">
  <Button
    as="a"
    variant="outline"
    href={githubUrl}
    target="_blank"
    rel="noopener noreferrer"
    class="gap-1.5 w-16"
  >
    <GithubIcon class="size-4" />
    <GitHubLink server:defer>
      <Skeleton class="w-8.5 h-5 rounded-sm" slot="fallback" />
    </GitHubLink>
  </Button>
  <PresetSwitcher />
  <starlight-theme-select>
    <Tabs class="theme-tabs" id="theme-tabs">
      <TabsList class="h-9 p-1 py-0.5 rounded-md">
        <TabsTrigger
          value="light"
          class="theme-tab px-1.5 h-7"
          title="Light theme"
        >
          <SunIcon class="size-4" />
        </TabsTrigger>
        <TabsTrigger
          value="dark"
          class="theme-tab px-1.5 h-7"
          title="Dark theme"
        >
          <MoonIcon class="size-4" />
        </TabsTrigger>
        <TabsTrigger
          value="auto"
          class="theme-tab px-1.5 h-7"
          title="Auto (system)"
        >
          <LaptopIcon class="size-4" />
        </TabsTrigger>
      </TabsList>
    </Tabs>
  </starlight-theme-select>
</div>

<!-- Theme Editor Panel (Cmd/Ctrl + . to toggle) -->
<ThemeEditorGlobal />

<script is:inline>
  if (typeof StarlightThemeProvider !== "undefined") {
    StarlightThemeProvider.updatePickers();
  }
</script>

<script>
  type Theme = "auto" | "dark" | "light";
  const storageKey = "starlight-theme";

  const parseTheme = (theme: unknown): Theme =>
    theme === "auto" || theme === "dark" || theme === "light" ? theme : "auto";

  const loadTheme = (): Theme =>
    parseTheme(
      typeof localStorage !== "undefined" && localStorage.getItem(storageKey),
    );

  function storeTheme(theme: Theme): void {
    if (typeof localStorage !== "undefined") {
      localStorage.setItem(
        storageKey,
        theme === "light" || theme === "dark" ? theme : "",
      );
    }
  }

  const getPreferredColorScheme = (): Theme =>
    matchMedia("(prefers-color-scheme: light)").matches ? "light" : "dark";

  function onThemeChange(theme: Theme): void {
    const resolved = theme === "auto" ? getPreferredColorScheme() : theme;
    if (typeof StarlightThemeProvider !== "undefined") {
      StarlightThemeProvider.updatePickers(theme);
    }
    document.documentElement.dataset.theme = resolved;
    document.documentElement.dataset.themeChoice = theme;
    document.documentElement.classList.toggle("dark", resolved === "dark");
    storeTheme(theme);
    // Dispatch event for other components (like PresetSwitcher) to react
    window.dispatchEvent(
      new CustomEvent("theme-toggle-changed", { detail: { theme: resolved } }),
    );

    document
      .querySelector<HTMLDivElement>("#theme-tabs")
      ?.dispatchEvent(
        new CustomEvent("tabs:set", { detail: { value: theme } }),
      ) as HTMLDivElement;
  }

  matchMedia("(prefers-color-scheme: light)").addEventListener("change", () => {
    if (loadTheme() === "auto") onThemeChange("auto");
  });

  class StarlightThemeSelect extends HTMLElement {
    connectedCallback() {
      const currentTheme = loadTheme();
      onThemeChange(currentTheme);

      const el = document.querySelector("#theme-tabs");
      el?.addEventListener("tabs:change", (e) => {
        onThemeChange(parseTheme(e.detail.value));
      });
    }
  }

  if (!customElements.get("starlight-theme-select")) {
    customElements.define("starlight-theme-select", StarlightThemeSelect);
  }
</script>

<style>
  .theme-tabs {
    gap: 0;
  }

  .theme-tab[data-state="active"] {
    color: var(--foreground);
  }

  .theme-tab[data-state="inactive"] {
    color: var(--muted-foreground);
  }
</style>
